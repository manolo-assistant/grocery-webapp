<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Order Review</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--tg-theme-bg-color, #fff);
  color: var(--tg-theme-text-color, #000);
  padding-bottom: 140px;
}
.header {
  position: sticky; top: 0;
  background: var(--tg-theme-bg-color, #fff);
  padding: 16px;
  border-bottom: 1px solid rgba(128,128,128,0.15);
  z-index: 10;
}
.header h1 { font-size: 1.25em; }
.header .summary { font-size: 0.85em; color: var(--tg-theme-hint-color, #999); margin-top: 4px; }
.toggle-all {
  display: inline-block; margin-top: 8px; font-size: 0.8em;
  color: var(--tg-theme-link-color, #3390ec); cursor: pointer;
}
.items { padding: 4px 0; }
.item {
  display: flex; align-items: center;
  padding: 10px 16px; gap: 10px;
  border-bottom: 1px solid rgba(128,128,128,0.08);
  transition: opacity 0.2s;
}
.item.off { opacity: 0.35; }
.check {
  width: 22px; height: 22px; border-radius: 50%;
  border: 2px solid var(--tg-theme-button-color, #3390ec);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; cursor: pointer;
}
.check.on { background: var(--tg-theme-button-color, #3390ec); }
.check.on::after { content: '‚úì'; color: var(--tg-theme-button-text-color, #fff); font-size: 13px; font-weight: 700; }
.info { flex: 1; min-width: 0; }
.info .name { font-size: 0.9em; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.info .unit-price { font-size: 0.75em; color: var(--tg-theme-hint-color, #999); margin-top: 2px; }
.qty { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.qty button {
  width: 26px; height: 26px; border-radius: 50%;
  border: 1.5px solid var(--tg-theme-button-color, #3390ec);
  background: transparent; color: var(--tg-theme-button-color, #3390ec);
  font-size: 15px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.qty button.dim { opacity: 0.3; }
.qty .val { min-width: 18px; text-align: center; font-weight: 600; font-size: 0.9em; }
.line-total { font-weight: 600; font-size: 0.9em; min-width: 48px; text-align: right; flex-shrink: 0; }

/* Bottom bar with approve button ‚Äî always visible */
.bottom-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom));
  background: var(--tg-theme-bg-color, #fff);
  border-top: 1px solid rgba(128,128,128,0.15);
  z-index: 50;
}
.btn-approve {
  width: 100%; padding: 14px; border: none; border-radius: 10px;
  background: var(--tg-theme-button-color, #3390ec);
  color: var(--tg-theme-button-text-color, #fff);
  font-size: 1em; font-weight: 600; cursor: pointer;
}

/* Copy overlay ‚Äî hidden by default */
#copyScreen {
  display: none;
  position: fixed; inset: 0;
  background: var(--tg-theme-bg-color, #fff);
  z-index: 200;
  flex-direction: column; align-items: center; justify-content: center;
  padding: 24px; gap: 16px;
}
#copyScreen.show { display: flex; }
#copyScreen h2 { font-size: 1.3em; }
#copyScreen .hint { font-size: 0.85em; color: var(--tg-theme-hint-color, #999); text-align: center; }
#codeBox {
  width: 100%; font-size: 0.85em; padding: 12px;
  border-radius: 8px; border: 1px solid var(--tg-theme-hint-color, #ccc);
  background: var(--tg-theme-secondary-bg-color, #f5f5f5);
  color: var(--tg-theme-text-color, #000); resize: none;
  -webkit-user-select: all; user-select: all;
}
.btn-copy {
  width: 100%; padding: 14px; border: none; border-radius: 10px;
  background: var(--tg-theme-button-color, #3390ec);
  color: var(--tg-theme-button-text-color, #fff);
  font-size: 1em; font-weight: 600; cursor: pointer;
}
#copyStatus { font-size: 0.8em; color: var(--tg-theme-hint-color, #999); }
</style>
</head>
<body>

<div class="header">
  <h1>üõí Order Review</h1>
  <div class="summary" id="summary">Loading‚Ä¶</div>
  <span class="toggle-all" id="toggleAll" onclick="toggleAll()">Deselect all</span>
</div>

<div class="items" id="items"></div>

<!-- Always-visible approve button -->
<div class="bottom-bar">
  <button class="btn-approve" id="approveBtn" onclick="approve()">Approve</button>
</div>

<!-- Pre-rendered copy screen -->
<div id="copyScreen">
  <h2>‚úÖ Order ready!</h2>
  <p class="hint">Copy this code and paste it in the chat:</p>
  <textarea id="codeBox" readonly rows="3"></textarea>
  <button class="btn-copy" onclick="copyCode()">üìã Copy Code</button>
  <div id="copyStatus">Tap the code to select it, or use the button</div>
  <button class="btn-copy" onclick="location.reload()" style="background:transparent;color:var(--tg-theme-link-color,#3390ec);margin-top:8px;">‚Üê Back to list</button>
</div>

<script>
const tg = window.Telegram?.WebApp;
const hasTg = !!(tg && tg.initData);
if (tg) tg.ready();
if (hasTg) tg.expand();

let items = [], origQty = [];
try {
  const d = new URLSearchParams(location.search).get('d');
  if (d) {
    items = JSON.parse(atob(d.replace(/-/g, '+').replace(/_/g, '/')));
    items.forEach(it => { if (it.on === undefined) it.on = true; if (!it.q || it.q < 0) it.q = 1; });
    origQty = items.map(it => it.q);
  }
} catch(e) { console.error(e); }

function render() {
  const el = document.getElementById('items');
  const sum = document.getElementById('summary');
  const tog = document.getElementById('toggleAll');
  const btn = document.getElementById('approveBtn');
  if (!items.length) { el.innerHTML = '<div style="text-align:center;padding:60px;opacity:0.5">No items</div>'; return; }
  let html = '', count = 0, total = 0;
  items.forEach((it, i) => {
    const on = it.on && it.q > 0, lt = on ? it.p * it.q : 0;
    if (on) { count++; total += lt; }
    html += `<div class="item ${on?'':'off'}">
      <div class="check ${on?'on':''}" onclick="toggle(${i})"></div>
      <div class="info"><div class="name">${esc(it.n)}</div>
        <div class="unit-price">$${it.p.toFixed(2)}${it.q>1?' √ó '+it.q:''}</div></div>
      <div class="qty">
        <button class="${it.q<=0?'dim':''}" onclick="qtyDelta(${i},-1)">‚àí</button>
        <span class="val">${it.q}</span>
        <button class="${it.q>=20?'dim':''}" onclick="qtyDelta(${i},1)">+</button>
      </div>
      <div class="line-total">${on?'$'+lt.toFixed(2):'‚Äî'}</div></div>`;
  });
  el.innerHTML = html;
  sum.textContent = `${count} of ${items.length} items ¬∑ $${total.toFixed(2)}`;
  tog.textContent = items.every(it => it.on && it.q > 0) ? 'Deselect all' : 'Select all';
  btn.textContent = count > 0 ? `Approve ¬∑ $${total.toFixed(2)}` : 'Nothing selected';
  btn.disabled = count === 0;
}

function toggle(i) { if (!items[i].on && items[i].q===0) items[i].q=1; items[i].on=!items[i].on; render(); }
function qtyDelta(i,d) { const n=items[i].q+d; if(n<0||n>20)return; items[i].q=n; if(n===0)items[i].on=false; if(n>0&&!items[i].on)items[i].on=true; render(); }
function toggleAll() { const all=items.every(it=>it.on&&it.q>0); items.forEach(it=>{it.on=!all;if(!all&&it.q===0)it.q=1;}); render(); }

function approve() {
  const approved = items.filter(it => it.on && it.q > 0);
  if (!approved.length) return;
  const total = approved.reduce((s,it) => s + it.p * it.q, 0);
  const code = 'GA:' + approved.map(a => a.q===1 ? a.i : a.i+'x'+a.q).join(',') + '=$' + total.toFixed(2);

  // Try sendData first ‚Äî if it works, webapp closes instantly
  const debug = [];
  debug.push('tg=' + !!tg);
  debug.push('initData=' + !!(tg && tg.initData));
  debug.push('initData.len=' + (tg?.initData?.length || 0));
  debug.push('platform=' + (tg?.platform || 'none'));
  debug.push('version=' + (tg?.version || 'none'));

  if (tg && tg.initData) {
    try {
      debug.push('calling sendData...');
      tg.sendData(code);
      debug.push('sendData returned (app should close)');
      // If still here after 1s, sendData didn't close the app ‚Üí fallback
      setTimeout(() => showCopyScreen(code, debug.join('\n')), 1000);
      return;
    } catch(e) {
      debug.push('sendData ERROR: ' + e.message);
    }
  } else {
    debug.push('skipped sendData (no initData)');
  }

  // Fallback: copy screen
  showCopyScreen(code, debug.join('\n'));
}

function showCopyScreen(code, debugInfo) {
  document.getElementById('codeBox').value = code;
  document.getElementById('copyScreen').classList.add('show');
  if (debugInfo) {
    document.getElementById('copyStatus').innerHTML =
      '<pre style="text-align:left;font-size:0.7em;background:var(--tg-theme-secondary-bg-color,#f5f5f5);'
      + 'padding:8px;border-radius:6px;overflow-x:auto;white-space:pre-wrap;margin-top:8px;">'
      + debugInfo + '</pre>';
  }
  setTimeout(() => { const b = document.getElementById('codeBox'); b.focus(); b.select(); }, 200);
}

function copyCode() {
  const box = document.getElementById('codeBox');
  const status = document.getElementById('copyStatus');
  box.focus(); box.select(); box.setSelectionRange(0, 99999);
  let ok = false;
  try { ok = document.execCommand('copy'); } catch(e) {}
  if (!ok) { try { navigator.clipboard.writeText(box.value); ok = true; } catch(e) {} }
  status.textContent = ok ? '‚úÖ Copied! Close this and paste in chat.' : 'Long-press the text above to copy manually.';
}

function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

render();
</script>
</body>
</html>
